# 服务端优化方式

通过调整前端与服务端之间的请求时机和请求方式，来减少服务端耗时对于渲染性能的影响面。

## 按需异步获取数据

类似按需渲染的场景，一个页面往往需要请求多个服务。除了渲染页面主要模块所必须请求的核心服务外，其他次要模块的服务请求可以按需延后在 TTI 阶段之后。

<img src="https://s3.ax1x.com/2021/02/04/y1jru9.png" style="zoom:50%" />


采用`按需渲染`这一小节中的图示来说明，浮层内容在渲染的页面中并不属于核心模块，采用按需请求的方式，当用户点击红色内容入口时，再获取数据进行渲染。

## 服务预搜索

除静态界面外，几乎所有采用 CSR 的页面都需要在渲染过程中发送服务请求，再根据服务请求返回的内容渲染页面。

等待服务请求响应的时长将直接拖慢到达 TTI 阶段的耗时，那么是否可以提前发送服务请求？

前端在发送服务请求前往往需要拼接较多的请求参数，这些参数中存在很多变量，而这些变量的来源较多是取决于用户交互的结果。正因为这样的场景较多，提前发送服务请求的难度也陡然上升。同时，也会给服务端造成请求数量成倍增加的副作用。

处理的方式有以下几种，可根据业务形态的不同进行选择或组合：
- 区分业务不同场景，针对大部分场景做提前请求服务的操作
- 需要依据多个用户交互结果作为请求参数的场景，可配合 BI 用户模型做到较精准的提前请求

在提前发送请求服务后，在进入下一界面时，代码逻辑仍然会正常发送服务请求，这里需要做好网络缓存。具体操作方式如下：
- 请求服务时，根据请求的 url 和参数通过 Hash 生成一个唯一的 Key
- 请求返回时，将服务返回的数据存入本地缓存
- 发送相同 url 和参数的请求，都会匹配已生成的 Key，从本地拿取缓存，而不进行真实的网络请求

具体流程如下图所示:

<img src="https://s3.ax1x.com/2021/01/27/szJsbV.png" style="zoom:50%" />
